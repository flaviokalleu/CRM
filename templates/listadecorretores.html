<style>
   #modal {
     background-color: #051139 !important;
     color: white !important; 
   }
 </style>
{% extends 'base.html' %}
{% load custom_filters %}
{% block main_content %}
<!DOCTYPE html>
<html lang="pt-br">
  {% load static %}
  {% load widget_tweaks %}
  <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Lista de Corretores</title>
     <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
     <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule="" src="https://cdn.jsdelivr.net/npm/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  </head>
  <body class="bg-gray-200 h-auto font-sans">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl mb-6 text-center font-bold">Lista de Corretores</h1>
        <table class="table align-items-center mb-0">
           <thead>
              <tr>
                 <th class="w-1/3 px-6 py-3 border-b border-gray-200 bg-gray-50 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Nome</th>
                 <th class="w-1/3 px-6 py-3 border-b border-gray-200 bg-gray-50 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Email</th>
                 <th class="w-1/3 px-6 py-3 border-b border-gray-200 bg-gray-50 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Ações</th>
              </tr>
           </thead>
           <tbody>
              {% for corretor in corretores %}
              <tr class="text-center">
                  <!-- Dados do Corretor -->
                  <td class="w-1/3 px-6 py-4 border-b border-gray-200">{{ corretor.first_name }} {{ corretor.last_name }}</td>
                  <td class="w-1/3 px-6 py-4 border-b border-gray-200">{{ corretor.email }}</td>
                  <td>
                     <button onclick="abrirModalEditar({{ corretor.pk }}, '{{ corretor.email }}')" class="btn btn-primary">Editar</button>
                  </td>
              </tr>
              {% endfor %}
           </tbody>
        </table>
<!-- Modal para Edição de Corretor -->
<div class="modal fade" id="editarCorretorModal" tabindex="-1" role="dialog" aria-labelledby="editarCorretorModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-dialog-centered" role="document">
       <div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title" id="editarCorretorModalLabel">Editar Corretor</h5>
               <button type="button" class="close" aria-label="Close" onclick="fecharModal()">
                <span aria-hidden="true">×</span>
            </button>
           </div>
           <div class="modal-body">
               <!-- Formulário para editar o email e senha -->
               <form id="formEditarCorretor">
                  {% csrf_token %}
                  <input type="hidden" id="corretorId" name="corretor_id">
                  <div class="form-group">
                      <label for="corretorEmail">Email</label>
                      <input type="email" class="form-control" id="corretorEmail" name="email">
                  </div>
                  <div class="form-group">
                      <label for="corretorSenha">Nova Senha</label>
                      <input type="password" class="form-control" id="corretorSenha" name="senha">
                  </div>
                  <button type="button" class="btn btn-primary" onclick="salvarAlteracoesCorretor()">Salvar Alterações</button>
               </form>              
           </div>
       </div>
   </div>
</div>


     </div>
     <script>
        var corretorAtualId = null;
        
        function abrirModalEditar(corretorId, corretorEmail) {
            corretorAtualId = corretorId;
            console.log("Abrindo modal para corretor ID:", corretorId);
            document.getElementById('corretorEmail').value = corretorEmail;
        
            // Mostra o modal usando jQuery
            $('#editarCorretorModal').modal('show');
        }
        
        function fecharModal() {
            // Fecha o modal usando jQuery
            $('#editarCorretorModal').modal('hide');
        }
        
        function salvarAlteracoesCorretor() {
            console.log("Salvando alterações para corretor ID:", corretorAtualId);
            var form = document.getElementById('formEditarCorretor');
            var formData = new FormData(form);
        
            enviarDadosCorretor(formData, corretorAtualId)
                .then(() => {
                    console.log('Dados do corretor atualizados com sucesso');
                    // Fecha o modal após salvar
                    fecharModal();
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert(`Erro: ${error.message}`);
                });
        }
        
        function enviarDadosCorretor(formData, corretorId) {
            return fetch(`/atualizar-corretor/${corretorId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao salvar as alterações.');
                }
                return response.json();
            });
        }
        
        function getCSRFToken() {
            return document.querySelector('#formEditarCorretor input[name="csrfmiddlewaretoken"]').value;
        }
        
        // Adiciona um ouvinte de evento quando o modal é fechado
        $('#editarCorretorModal').on('hidden.bs.modal', function () {
            // Realiza alguma ação após o fechamento do modal, se necessário
        });
        </script>
        
  </body>
</html>
{% endblock %}