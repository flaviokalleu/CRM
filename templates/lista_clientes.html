<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Clientes</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-900 text-gray-200 font-sans antialiased">
    <!-- Header -->
    <header class="bg-gray-800 px-6 py-4 shadow-md">
        <div class="container mx-auto flex flex-wrap justify-between items-center">
            <h2 class="text-3xl font-bold text-white mb-2 md:mb-0">Lista de Clientes</h2>
            <div class="flex items-center space-x-4">
                <img src="path_to_corretor_image.jpg" alt="Foto do Corretor" class="h-8 w-8 rounded-full">
                <button onclick="redirectToDashboard()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 border border-transparent rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300 transition duration-150 ease-in-out">
                    Voltar ao Dashboard
                </button>
            </div>
        </div>
    </header>

    <!-- Tabela de Clientes -->
    <main class="container mx-auto p-6 mt-6">
        <div class="bg-gray-900 rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-semibold">Clientes</h2>
                <input type="text" placeholder="Pesquisar cliente..." class="p-2 rounded-md bg-gray-800 w-64 focus:ring-2 focus:ring-indigo-600 focus:outline-none">
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-gray-800 rounded-lg divide-y divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Nome</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Email</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Status</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Corretor Nome</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Ação</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-600">
                        {% for cliente in clientes %}
                        <tr class="transition duration-300 ease-in-out hover:bg-gray-600">
                            <td class="px-6 py-4 text-center">{{ cliente.nome }}</td>
                            <td class="px-6 py-4 text-center">{{ cliente.email }}</td>
                            <td class="px-6 py-4 text-center">
                                <button class="
                                    px-4 py-2 rounded
                                    {% if cliente.status == "aguardando_aprovacao" %}
                                        bg-yellow-500
                                    {% elif cliente.status == "documentacao_pendente" %}
                                        bg-orange-500
                                    {% elif cliente.status == "aguardando_cancelamento_qv" %}
                                        bg-red-500
                                    {% elif cliente.status == "cliente_aprovado" %}
                                        bg-green-500
                                    {% elif cliente.status == "proposta_apresentada" %}
                                        bg-blue-500
                                    {% elif cliente.status == "visita_efetuada" %}
                                        bg-indigo-500
                                    {% elif cliente.status == "fechamento_proposta" %}
                                        bg-purple-500
                                    {% elif cliente.status == "pagamento_tsd" %}
                                        bg-pink-500
                                    {% elif cliente.status == "conformidade" %}
                                        bg-teal-500
                                    {% elif cliente.status == "assinatura_minuta_caixa" %}
                                        bg-gray-500
                                    {% elif cliente.status == "comissao_recebida" %}
                                        bg-lime-500
                                    {% elif cliente.status == "concluido" %}
                                        bg-emerald-500
                                    {% elif cliente.status == "reprovado" %}
                                        bg-rose-500
                                    {% else %}
                                        bg-gray-400
                                    {% endif %}
                                ">
                                    {{ cliente.get_status_display }}
                                </button>
                            </td>
                            
                            <td class="px-6 py-4 text-center">{{ cliente.corretor.first_name }} {{ cliente.corretor.last_name }}</td>

                            <td class="px-6 py-4 text-center">
                                <button onclick="abrirModal({{ cliente.id }})"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                                    Ver detalhes
                                </button>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal de Detalhes do Cliente -->
<div id="clienteModal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-60 flex items-center justify-center p-6 transition-opacity duration-300 hidden">
    <div class="bg-gray-900 rounded-lg shadow-2xl w-full md:w-3/4 lg:w-1/2">
        <div class="border-b border-gray-700 p-6 text-xl font-semibold text-white">
            Detalhes do Cliente
        </div>
        <div class="p-6 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-300">
                <div><strong>Nome:</strong> <span id="modalNome"></span></div>
                <div><strong>Email:</strong> <span id="modalEmail"></span></div>
                <div><strong>Telefone:</strong> <span id="modalTelefone"></span></div>
                <div><strong>CPF:</strong> <span id="modalCPF"></span></div>
                <div><strong>Estado Civil:</strong> <span id="modalEstadoCivil"></span></div>
                <div><strong>Naturalidade:</strong> <span id="modalNaturalidade"></span></div>
                <div><strong>Profissão:</strong> <span id="modalProfissao"></span></div>
                <div><strong>Data de Admissão:</strong> <span id="modalDataAdmissao"></span></div>
                <div><strong>Data de Nascimento:</strong> <span id="modalDataNascimento"></span></div>
                <div><strong>Tipo de Renda:</strong> <span id="modalRendaTipo"></span></div>
                <div><strong>Possui Carteira 3 anos:</strong> <span id="modalPossuiCarteira"></span></div>

                <div><strong>Número PIS:</strong> <span id="modalNumeroPIS"></span></div>
                <div><strong>Possui Dependente:</strong> <span id="modalPossuiDependente"></span></div>
                <!-- Campo de Status para edição -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-gray-300">
                    <div class="flex flex-col">
                        <label for="modalStatusInput" class="mb-2 font-semibold text-gray-400">
                            <strong>Status:</strong>
                        </label>
                        <div class="relative">
                            <select id="modalStatusInput" name="status" class="block appearance-none w-full bg-gray-800 border border-gray-600 text-white rounded-md py-3 px-4 leading-tight focus:outline-none focus:bg-gray-700 focus:border-indigo-500 hover:border-indigo-500">
                                <option value="aguardando_aprovacao">Aguardando Aprovação</option>
                                <option value="documentacao_pendente">Documentação Pendente</option>
                                <option value="aguardando_cancelamento_qv">Aguardando Cancelamento QV</option>
                                <option value="cliente_aprovado">Cliente Aprovado</option>
                                <option value="proposta_apresentada">Proposta Apresentada</option>
                                <option value="visita_efetuada">Visita Efetuada</option>
                                <option value="fechamento_proposta">Fechamento Proposta</option>
                                <option value="pagamento_tsd">Pagamento TSD</option>
                                <option value="conformidade">Conformidade</option>
                                <option value="assinatura_minuta_caixa">Assinatura Minuta Caixa</option>
                                <option value="comissao_recebida">Comissão Recebida</option>
                                <option value="concluido">Concluído</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-white">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M4.516 7.548c0.436-0.446 1.043-0.481 1.576 0l3.908 3.747 3.908-3.747c0.533-0.481 1.141-0.446 1.574 0 0.436 0.445 0.408 1.197 0 1.615-0.406 0.418-4.695 4.502-4.695 4.502-0.217 0.223-0.502 0.335-0.787 0.335s-0.57-0.112-0.789-0.335c0 0-4.287-4.084-4.695-4.502s-0.436-1.17 0-1.615z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="mt-4">
                <iframe id="pdfIframe" class="w-full h-[1000px] border rounded-lg shadow-md"></iframe>
            </div>
            
            <div class="text-center mt-4">
                <a id="pdfLink" href="#" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-gray-200 px-4 py-2 rounded">Abrir Documento em Nova Aba</a>
            </div>
        </div>
        <div class="border-t border-gray-700 p-4 flex justify-end space-x-4">
            <button data-cliente-id="{{ cliente.id }}" 
                    onclick="salvarAlteracoes(this.getAttribute('data-cliente-id'))" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 border border-transparent rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 transition duration-150 ease-in-out">
                Salvar Alterações
            </button>
        
            <button class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 border border-transparent rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-300 transition duration-150 ease-in-out" 
                    onclick="fecharModal()">
                Fechar
            </button>
        </div>
        
</div>
<script>
    var clientesData = {{ clientes_json|safe }};
</script>

<script>
    // Dados dos clientes, supondo que esteja no seu HTML como mencionado anteriormente.


    let currentClienteId;

    function abrirModal(clienteId) {
    currentClienteId = clienteId;
        console.log("Função abrirModal chamada. ID do cliente:", clienteId);
        // Resetar o src do iframe primeiro
        document.getElementById('pdfIframe').src = "";
    
        const cliente = clientesData.find(c => c.pk === clienteId);
        if (cliente) {
        // Preenchendo todos os detalhes
        document.getElementById('modalNome').textContent = cliente.fields.nome || "N/A";
        document.getElementById('modalEmail').textContent = cliente.fields.email || "N/A";
        document.getElementById('modalCPF').textContent = cliente.fields.cpf || "N/A";
        document.getElementById('modalTelefone').textContent = cliente.fields.telefone || "N/A";
        document.getElementById('modalEstadoCivil').textContent = cliente.fields.estado_civil || "N/A";
        document.getElementById('modalNaturalidade').textContent = cliente.fields.naturalidade || "N/A";
        document.getElementById('modalProfissao').textContent = cliente.fields.profissao || "N/A";
        document.getElementById('modalDataAdmissao').textContent = cliente.fields.data_admissao || "N/A";
        document.getElementById('modalDataNascimento').textContent = cliente.fields.data_nascimento || "N/A";
        document.getElementById('modalRendaTipo').textContent = cliente.fields.renda_tipo || "N/A";
        document.getElementById('modalPossuiCarteira').textContent = cliente.fields.possui_carteira_mais_tres_anos ? "Sim" : "Não";
        document.getElementById('modalNumeroPIS').textContent = cliente.fields.numero_pis || "N/A";
        document.getElementById('modalPossuiDependente').textContent = cliente.fields.possui_dependente ? "Sim" : "Não";
        
        
        // Configurar o iframe para o PDF da documentação do cliente
        let pdfPath = `/media/documentos/${cliente.fields.nome}-${cliente.fields.cpf}/${cliente.fields.nome}-${cliente.fields.cpf}.pdf`;
        document.getElementById('pdfIframe').src = pdfPath;
        document.getElementById('pdfLink').href = pdfPath;

        // Mostrar o modal
        document.getElementById('clienteModal').classList.remove('hidden');
        
    }

    }
    function fecharModal() {
        document.getElementById('clienteModal').classList.add('hidden');
    }

    function salvarAlteracoes() {   
        let novoStatus = document.getElementById('modalStatusInput').value;
    
        fetch('/atualizar-status-cliente/', {
            method: 'POST',
            body: new URLSearchParams({
                'cliente_id': currentClienteId,
                'novo_status': novoStatus
            }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (response && response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(`Erro na requisição: ${response.status} ${response.statusText}\n${text}`);
                });
            }
        })
        .then(data => {
            if (data.status === 'success') {
                alert('Alterações salvas com sucesso!');
                fecharModal();
                
                // Solicitação para enviar notificação
                return sendNotification();
    
            } else {
                console.error(data.error_message || "Erro desconhecido.");
                alert('Houve um erro ao salvar as alterações. ' + (data.error_message || ''));
            }
        })
        .catch(error => {
            console.error('Erro ao processar a resposta:', error);
            alert(`Erro: ${error.message}`);
        });
    }
    
    // Função para enviar notificação
    function sendNotification() {
        return fetch('/send-notification/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'cliente_id': currentClienteId })
        })
        .then(response => {
            if (response && response.ok) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error(`Erro na requisição: ${response.status} ${response.statusText}\n${text}`);
                });
            }
        })
        .then(data => {
            if (data.message) {
                alert(data.message);
            } else {
                console.error(data.error || "Erro desconhecido.");
                alert('Houve um erro ao enviar a notificação. ' + (data.error || ''));
            }
        });
    }
    
    
    
    
    function redirectToDashboard() {
        window.location.href = "/admin_dashboard";
    }

    
</script>

</body>
</html>
